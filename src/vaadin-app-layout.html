<!--
@license
Vaadin Navbar Layout
Copyright (C) 2019 Vaadin Ltd
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="safe-area-inset.html">
<link rel="import" href="detect-ios-navbar.html">
<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="vaadin-app-layout-mixin.html">
<link rel="import" href="../../polymer/lib/utils/flattened-nodes-observer.html">

<dom-module id="vaadin-app-layout">
  <template>
    <style include="vaadin-app-layout-mixin">
      :host {
        --vaadin-app-layout-touch-optimized: false;
        --vaadin-app-layout-navbar-offset-top: var(--_vaadin-app-layout-navbar-offset-size);
        --vaadin-app-layout-navbar-offset-bottom: var(--_vaadin-app-layout-navbar-offset-size-bottom);
        padding-top: var(--vaadin-app-layout-navbar-offset-top);
        padding-bottom: var(--vaadin-app-layout-navbar-offset-bottom);
        padding-left: var(--vaadin-app-layout-navbar-offset-left);
      }

      :host([drawer-opened]) {
        --vaadin-app-layout-drawer-offset-left: var(--_vaadin-app-layout-drawer-offset-size);
      }

      :host([overlay]) {
        --vaadin-app-layout-drawer-offset-left: 0;
        --vaadin-app-layout-navbar-offset-top: 0;
        --vaadin-app-layout-navbar-offset-bottom: 0;
        --vaadin-app-layout-navbar-offset-left: 0;
      }

      @media (pointer: coarse) and (max-width: 800px) and (min-height: 500px) {
        :host {
          --vaadin-app-layout-touch-optimized: true;
        }
      }

      [part="navbar"] {
        position: fixed;
        display: flex;
        top: 0;
        right: 0;
        left: 0;
        transition: left var(--vaadin-app-layout-transition);
        padding-top: var(--safe-area-inset-top);
        padding-left: var(--safe-area-inset-left);
        padding-right: var(--safe-area-inset-right);
      }

      :host([drawer-first][drawer-opened]:not([overlay])) [part="navbar"] {
        left: var(--vaadin-app-layout-drawer-offset-left, 0);
      }

      :host([drawer-first]) [part="drawer"] {
        top: 0;
      }

      :host([orientation="vertical"]) [part="navbar"][bottom] {
        top: auto;
        bottom: 0;
        padding-bottom: var(--safe-area-inset-bottom);
      }

      [part="drawer"] {
        position: fixed;
        top: var(--vaadin-app-layout-navbar-offset-top, 0);
        right: auto;
        bottom: var(--vaadin-app-layout-navbar-offset-bottom, var(--vaadin-viewport-offset-bottom, 0));
        left: var(--vaadin-app-layout-navbar-offset-left, 0);
        transition: transform var(--vaadin-app-layout-transition);
        transform: translateX(-100%);
        max-width: 90%;
        width: 16em;
        box-sizing: border-box;
        padding: var(--safe-area-inset-top) 0 var(--safe-area-inset-bottom) var(--safe-area-inset-left);
      }

      :host([drawer-opened]) [part="drawer"] {
        transform: translateX(0%);
        touch-action: manipulation;
      }

      [part="backdrop"] {
        background-color: #000;
        opacity: 0.3;
      }

      :host(:not([drawer-opened])) [part="backdrop"] {
        opacity: 0;
      }

      :host([overlay]) [part="backdrop"] {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        pointer-events: none;
        transition: opacity var(--vaadin-app-layout-transition);
        -webkit-tap-highlight-color: transparent;
      }

      :host([overlay]) [part="drawer"],
      :host([overlay]) [part="backdrop"] {
        z-index: 1;
      }

      :host([drawer-opened][overlay]) [part="backdrop"] {
        pointer-events: auto;
        touch-action: manipulation;
      }

      :host([drawer-opened]:not([overlay])) {
        padding-left: var(--vaadin-app-layout-drawer-offset-left);
      }

      @media (max-width: 800px),
      (max-height: 600px) {
        :host {
          --vaadin-app-layout-drawer-overlay: true;
        }

        [part="drawer"] {
          width: 20em;
        }
      }

      :host([orientation="horizontal"]) {
        --vaadin-app-layout-navbar-offset-top: 0;
        --vaadin-app-layout-navbar-offset-left: var(--_vaadin-app-layout-navbar-offset-size);
      }

      :host([orientation="horizontal"]) [part="navbar"] {
        right: auto;
        bottom: var(--vaadin-viewport-offset-bottom, 0);
      }
    </style>
    <div part="backdrop" on-click="_close" on-touchstart="_close"></div>
    <div part="drawer">
      <slot name="drawer" id="drawer"></slot>
    </div>
    <div content>
      <slot></slot>
    </div>
    <div part="navbar">
      <slot name="navbar"></slot>
    </div>
    <div part="navbar" bottom hidden>
      <slot name="navbar-bottom"></slot>
    </div>
  </template>
  <script>
    (function() {

      /**
       * @memberof Vaadin
       * @mixes Vaadin.AppLayoutMixin
       * @extends Polymer.Element
       * @demo demo/index.html
       */
      class AppLayoutElement extends Vaadin.AppLayoutMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-app-layout';
        }

        static get version() {
          return '2.0.0-alpha1';
        }

        static get properties() {
          return {
            // vertical (default) or horizontal
            orientation: {
              type: String,
              value: 'vertical',
              reflectToAttribute: true
            },

            drawerFirst: {
              type: Boolean,
              reflectToAttribute: true
            },

            drawerOpened: {
              type: Boolean,
              value: true,
              reflectToAttribute: true
            },

            // Drawer is an overlay on top of the content
            // Controlled via CSS using --vaadin-app-layout-drawer-overlay: true|false;
            overlay: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
            }
          };
        }

        connectedCallback() {
          super.connectedCallback();

          this._updateTouchOptimizedMode();
          this._setupDrawerToggleClickListener();

          this._navbarChildObserver = new Polymer.FlattenedNodesObserver(this.$.drawer, (info) => {
            this._updateDrawerSize();
          });
          this._updateDrawerSize();
        }

        _setupDrawerToggleClickListener() {
          this.toggleClickListener = this.addEventListener('drawer-toggle-click', this._drawerToggleClickListener);
        }

        _drawerToggleClickListener(e) {
          e.stopPropagation();
          this.drawerOpened = !this.drawerOpened;
        }

        _updateDrawerSize() {
          const childCount = this.querySelectorAll('[slot=drawer]').length;
          const drawer = this.shadowRoot.querySelector('[part=drawer]');

          if (childCount === 0) {
            drawer.setAttribute('hidden', '');
          } else {
            drawer.removeAttribute('hidden');
          }
          this._updateOffsetSize();
        }

        disconnectedCallback() {
          super.disconnectedCallback();

          this._navbarChildObserver && this._navbarChildObserver.disconnect();
          this.removeEventListener('drawer-toggle-click', this._drawerToggleClickListener);
        }

        _resize() {
          super._resize();
          this._updateTouchOptimizedMode();
          this._updateOverlayMode();
        }

        _updateOffsetSize() {
          super._updateOffsetSize();

          const navbar = this.shadowRoot.querySelector('[part="navbar"]');
          const navbarRect = navbar.getBoundingClientRect();

          // TODO(jouni): use shady css if we want to support IE11
          if (this.orientation == 'vertical') {
            this.style.setProperty('--_vaadin-app-layout-navbar-offset-size', navbarRect.height + 'px');

            const navbarBottom = this.shadowRoot.querySelector('[part="navbar"][bottom]');
            const navbarBottomRect = navbarBottom.getBoundingClientRect();
            this.style.setProperty('--_vaadin-app-layout-navbar-offset-size-bottom', navbarBottomRect.height + 'px');
          } else {
            this.style.setProperty('--_vaadin-app-layout-navbar-offset-size', navbarRect.width + 'px');
          }

          const drawer = this.shadowRoot.querySelector('[part="drawer"]');
          const drawerRect = drawer.getBoundingClientRect();

          // TODO(jouni): use shady css if we want to support IE11
          this.style.setProperty('--_vaadin-app-layout-drawer-offset-size', drawerRect.width + 'px');
        }

        _updateOverlayMode() {
          // TODO(jouni): use shady css if we want to support IE11
          let overlay = getComputedStyle(this).getPropertyValue('--vaadin-app-layout-drawer-overlay');
          overlay = overlay.trim().toLowerCase() == 'true';

          this.overlay = overlay;

          if (this.overlay) {
            this.drawerOpened = false;
          }

          // TODO(jouni): ARIA attributes. The drawer should act similar to a modal dialog when in ”overlay” mode
        }

        // TODO(jouni): what mechanism should we use to close the overlay drawer a navigation is triggered?
        _close() {
          this.drawerOpened = false;
        }

        _updateTouchOptimizedMode() {
          // TODO(jouni): use shady css if we want to support IE11
          let touchOptimized = getComputedStyle(this).getPropertyValue('--vaadin-app-layout-touch-optimized');
          touchOptimized = touchOptimized.trim().toLowerCase() == 'true';

          const navbarBottom = this.shadowRoot.querySelector('[part="navbar"][bottom]');
          const navbars = this.querySelectorAll('[slot*="navbar"]');

          if (navbars.length > 0) {
            Array.from(navbars).forEach(navbar => {
              if (navbar.getAttribute('slot').indexOf('touch-optimized') > -1) {
                navbar.__touchOptimized = true;
              }

              if (this.orientation == 'vertical' && touchOptimized && navbar.__touchOptimized) {
                navbar.setAttribute('slot', 'navbar-bottom');
              } else {
                navbar.setAttribute('slot', 'navbar');
              }
            });
          }

          if (this.orientation == 'vertical' && touchOptimized) {
            navbarBottom.removeAttribute('hidden');
          } else {
            navbarBottom.setAttribute('hidden', '');
          }

          this._updateOffsetSize();
        }
      }

      customElements.define(AppLayoutElement.is, AppLayoutElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.AppLayoutElement = AppLayoutElement;
    })();
  </script>
</dom-module>
