<!--
@license
Vaadin Drawer Layout
Copyright (C) 2019 Vaadin Ltd
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="safe-area-inset.html">
<link rel="import" href="detect-ios-navbar.html">
<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="vaadin-app-layout-mixin.html">

<dom-module id="vaadin-drawer-layout">
  <template>
    <style include="vaadin-app-layout-mixin">
      :host([opened]) {
        --vaadin-drawer-layout-offset-left: var(--_vaadin-drawer-layout-offset-size);
      }

      :host([overlay]) {
        --vaadin-drawer-layout-offset-left: 0;
        --vaadin-navbar-layout-offset-top: 0;
        --vaadin-navbar-layout-offset-bottom: 0;
        --vaadin-navbar-layout-offset-left: 0;
      }

      [part="drawer"] {
        position: fixed;
        top: var(--vaadin-navbar-layout-offset-top, 0);
        right: auto;
        bottom: var(--vaadin-navbar-layout-offset-bottom, var(--vaadin-viewport-offset-bottom, 0));
        left: var(--vaadin-navbar-layout-offset-left, 0);
        transition: transform var(--vaadin-app-layout-transition);
        transform: translateX(-100%);
        max-width: 90%;
        width: 16em;
        box-sizing: border-box;
        padding: var(--safe-area-inset-top) 0 var(--safe-area-inset-bottom) var(--safe-area-inset-left);
      }

      :host([opened]) [part="drawer"] {
        transform: translateX(0%);
        touch-action: manipulation;
      }

      [part="backdrop"] {
        background-color: #000;
        opacity: 0.3;
      }

      :host(:not([opened])) [part="backdrop"] {
        opacity: 0;
      }

      :host([overlay]) [part="backdrop"] {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        pointer-events: none;
        transition: opacity var(--vaadin-app-layout-transition);
        -webkit-tap-highlight-color: transparent;
      }

      :host([overlay]) [part="drawer"],
      :host([overlay]) [part="backdrop"] {
        z-index: 1;
      }

      :host([opened][overlay]) [part="backdrop"] {
        pointer-events: auto;
        touch-action: manipulation;
      }

      :host([opened]:not([overlay])) {
        padding-left: var(--vaadin-drawer-layout-offset-left);
      }

      @media (max-width: 800px), (max-height: 600px) {
        :host {
          --vaadin-drawer-layout-overlay: true;
        }

        [part="drawer"] {
          width: 20em;
        }
      }
    </style>
    <div content>
      <slot></slot>
    </div>
    <div part="backdrop" on-click="_close" on-touchstart="_close"></div>
    <div part="drawer">
      <slot name="drawer"></slot>
    </div>
  </template>
  <script>
    (function() {

      /**
       * @memberof Vaadin
       * @mixes Vaadin.AppLayoutMixin
       * @extends Polymer.Element
       * @demo demo/index.html
       */
      class DrawerLayoutElement extends Vaadin.AppLayoutMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-drawer-layout';
        }

        static get version() {
          return '1.0.0';
        }

        static get properties() {
          return {
            // Drawer visible or not
            opened: {
              type: Boolean,
              value: true,
              reflectToAttribute: true,
              observer: '_openedChanged'
            },

            // Drawer is an overlay on top of the content
            // Controlled via CSS using --vaadin-drawer-layout-overlay: true|false;
            overlay: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
            }
          };
        }

        connectedCallback() {
          super.connectedCallback();
          this._updateOverlayMode();
        }

        _openedChanged() {
          // TODO(jouni): hide the drawer from keyboard and screen readers when closed
        }

        _resize() {
          super._resize();
          this._updateOverlayMode();
        }

        _updateOffsetSize() {
          super._updateOffsetSize();

          const drawer = this.shadowRoot.querySelector('[part="drawer"]');
          const rect = drawer.getBoundingClientRect();

          // TODO(jouni): use shady css if we want to support IE11
          this.style.setProperty('--_vaadin-drawer-layout-offset-size', rect.width + 'px');
        }

        _updateOverlayMode() {
          // TODO(jouni): use shady css if we want to support IE11
          let overlay = getComputedStyle(this).getPropertyValue('--vaadin-drawer-layout-overlay');
          overlay = overlay.trim().toLowerCase() == 'true';

          this.overlay = overlay;

          if (this.overlay) {
            this.opened = false;
          }

          // TODO(jouni): ARIA attributes. The drawer should act similar to a modal dialog when in ”overlay” mode
        }

        // TODO(jouni): what mechanism should we use to close the overlay drawer a navigation is triggered?
        _close() {
          this.opened = false;
        }
      }

      customElements.define(DrawerLayoutElement.is, DrawerLayoutElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.DrawerLayoutElement = DrawerLayoutElement;
    })();
  </script>
</dom-module>
