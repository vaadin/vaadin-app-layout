<!--
@license
Vaadin Drawer Layout
Copyright (C) 2019 Vaadin Ltd
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="vaadin-app-layout-base.html">

<dom-module id="vaadin-drawer-layout-style">
  <template>
    <style>
      :host([orientation="horizontal"]) [offset-element] {
        /* TODO(jouni): update once we support aligning the drawer to end (right/bottom side) of the layout */
        transform: translateX(-100%);
        max-width: 80%;
      }

      :host([orientation="vertical"]) [offset-element] {
        /* TODO(jouni): update once we support aligning the drawer to end (right/bottom side) of the layout */
        transform: translateY(-100%);
        max-height: 80%;
      }

      :host([opened]) [offset-element] {
        transform: translateX(0%);
        touch-action: manipulation;
      }

      [part="backdrop"] {
        position: fixed;
      }

      :host([drawer-overlay]) [part="backdrop"] {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: #000;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--vaadin-app-layout-transition);
        -webkit-tap-highlight-color: transparent;
      }

      :host(.no-anim) [part="backdrop"] {
        transition: none !important;
      }

      :host([drawer-overlay]) [offset-element],
      :host([drawer-overlay]) [part="backdrop"] {
        z-index: 1;
      }

      :host([orientation^="horizontal"]:not([drawer-overlay])) [offset-element] {
        top: var(--vaadin-navbar-layout-offset, 0);
        bottom: var(--vaadin-viewport-offset-bottom, 0);
      }

      :host([opened][drawer-overlay]) [part="backdrop"] {
        opacity: 0.3;
        pointer-events: auto;
        touch-action: manipulation;
      }

      :host([orientation="vertical"][opened]:not([drawer-overlay])) {
        padding-top: var(--vaadin-drawer-layout-offset);
      }

      :host([orientation="vertical-reverse"][opened]:not([drawer-overlay])) {
        padding-bottom: var(--vaadin-drawer-layout-offset);
      }

      :host([orientation="horizontal"][opened]:not([drawer-overlay])) {
        padding-left: var(--vaadin-drawer-layout-offset);
      }

      :host([orientation="horizontal-reverse"][opened]:not([drawer-overlay])) {
        padding-right: var(--vaadin-drawer-layout-offset);
      }

    </style>
  </template>
</dom-module>

<dom-module id="vaadin-navbar-layout">
  <script>
    (function() {

      /**
       *
       * @memberof Vaadin
       * @extends Vaadin.AppLayoutBaseElement
       * @demo demo/index.html
       */
      class DrawerLayoutElement extends Vaadin.AppLayoutBaseElement {
        static get is() {
          return 'vaadin-drawer-layout';
        }

        static get version() {
          return '1.0.0';
        }

        static get template() {
          return this._modifiedTemplate('drawer');
        }

        static get properties() {
          return {
            // Drawer visible or not
            opened: {
              type: Boolean,
              value: true,
              reflectToAttribute: true,
              observer: '_openedChanged'
            },

            // State for styling
            drawerOverlay: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
            },

            // Forces the drawer to always be an overlay on top of the content
            overlayMode: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
            }
          };
        }

        constructor() {
          super();
          this.orientation = 'horizontal';
        }

        connectedCallback() {
          super.connectedCallback();
          this._updateOverlayMode();
        }

        _openedChanged() {
          if (!this.shadowRoot.querySelector('[part="backdrop"]')) {
            const backdrop = document.createElement('div');
            backdrop.setAttribute('part', 'backdrop');
            this.shadowRoot.insertBefore(backdrop, this.shadowRoot.querySelector('[offset-element]'));
            backdrop.addEventListener('click', () => this.opened = false);
            backdrop.addEventListener('touchstart', () => this.opened = false);
          }

          if (this.opened) {
            this._updateOffsetSize(true);
          } else {
            // TODO hide the drawer from keyboard nav when closed
            this.style.setProperty('--vaadin-drawer-layout-offset', '');
          }

          // On iOS, -webkit-overflow-scrolling: touch; creates a new clipping context for fixed elements
          if (window.navigator.userAgent.match(/iPhone|iPad/i) && this.parentNode && this.parentNode instanceof Vaadin.AppLayoutBaseElement) {
            if (this.opened) {
              this.parentNode.setAttribute('ios-fix', '');
            } else {
              this.parentNode.removeAttribute('ios-fix');
            }
          }
        }

        _resize() {
          super._resize();
          this._updateOverlayMode();
        }

        _updateOverlayMode() {
          const threshold = getComputedStyle(this).getPropertyValue('--vaadin-app-layout-threshold');

          // TODO(jouni): support all CSS units, not just px
          if (this.overlayMode || this.offsetWidth <= parseInt(threshold)) {
            this.opened = false;
            this.drawerOverlay = true;
          } else {
            this.drawerOverlay = false;
          }

          // TODO(jouni): ARIA attributes. The drawer should act similar to a modal dialog when in ”overlay” mode
        }
      }

      customElements.define(DrawerLayoutElement.is, DrawerLayoutElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.DrawerLayoutElement = DrawerLayoutElement;
    })();
  </script>
</dom-module>
