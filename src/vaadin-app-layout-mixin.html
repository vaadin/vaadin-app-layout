<!--
@license
Vaadin App Layout Base
Copyright (C) 2019 Vaadin Ltd
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="safe-area-inset.html">
<link rel="import" href="detect-ios-navbar.html">
<link rel="import" href="../../polymer/lib/utils/render-status.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">

<dom-module id="vaadin-app-layout-mixin">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        height: 100%;
        --vaadin-app-layout-transition: 200ms;
        transition: padding var(--vaadin-app-layout-transition);
      }

      :host([hidden]) {
        display: none !important;
      }

      :host([no-anim]) {
        --vaadin-app-layout-transition: none !important;
      }

      [content] {
        height: 100%;
      }

      :host(:not([no-scroll])) [content] {
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </template>
  <script>
    /**
     * @namespace Vaadin
     */
    window.Vaadin = window.Vaadin || {};

    /**
     * @polymerMixin
     * @memberof Vaadin
     * @private
     */
    Vaadin.AppLayoutMixin = superClass => class VaadinAppLayoutMixin extends Vaadin.ElementMixin(Vaadin.ThemableMixin(superClass)) {
      constructor() {
        super();
        this.__VaadinAppLayoutMixin = true;
        // TODO(jouni): might want to debounce
        this.__boundResizeListener = this._resize.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();

        window.addEventListener('resize', this.__boundResizeListener);

        // Wait for all children to upgrade before trying to measure sizes
        if (window.HTMLImports && !window.HTMLImports.useNative) {
          Array.from(this.querySelectorAll('*')).forEach(child => {
            if (child.localName.indexOf('-') > -1) {
              window.customElements.whenDefined(child.localName).then(() => {
                // TODO(jouni): might want to debounce
                this._afterFirstRender();
              });
            }
          });
        } else {
          Polymer.RenderStatus.afterNextRender(this, this._afterFirstRender);
        }
      }

      disconnectedCallback() {
        window.removeEventListener('resize', this.__boundResizeListener);
        super.disconnectedCallback();
      }

      _afterFirstRender() {
        this._blockAnimationUntilAfterNextRender();
        this._updateOffsetSize();
        // On iOS, -webkit-overflow-scrolling: touch; creates a new positioning/clipping context for fixed elements
        // Only matches the direct parent, as the navbar/drawer layouts should be directly nested
        if (this.parentNode.__VaadinAppLayoutMixin) {
          this.parentNode.setAttribute('no-scroll', '');
        }
      }

      _resize() {
        this._blockAnimationUntilAfterNextRender();
      }

      _updateOffsetSize() {
      }

      _blockAnimationUntilAfterNextRender() {
        this.setAttribute('no-anim', '');
        Polymer.RenderStatus.afterNextRender(this, () => this.removeAttribute('no-anim'));
      }
    };
  </script>
</dom-module>
